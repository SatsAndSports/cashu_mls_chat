<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDK Ecash Web Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #header {
            background: #0066cc;
            color: white;
            padding: 15px 20px;
            font-size: 1.2em;
        }
        #main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        #sidebar {
            width: 250px;
            background: #f5f5f5;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }
        .nav-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
            transition: background 0.2s;
        }
        .nav-item:hover {
            background: #e6e6e6;
        }
        .nav-item.active {
            background: white;
            border-left: 3px solid #0066cc;
            padding-left: 17px;
        }
        #content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .npub {
            font-family: monospace;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
            margin: 10px 0;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
        }
        button:hover {
            background: #0052a3;
        }
        .error {
            color: red;
            padding: 10px;
            background: #ffe6e6;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: green;
            padding: 10px;
            background: #e6ffe6;
            border-radius: 4px;
            margin: 10px 0;
        }
        .group-item {
            padding: 10px;
            background: #f5f5f5;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .group-item:hover {
            background: #e6e6e6;
        }
        .group-item.active {
            background: #0066cc;
            color: white;
        }
    </style>
</head>
<body>
    <div id="header">üîê MDK Ecash Web Client</div>

    <div id="main">
        <!-- Sidebar -->
        <div id="sidebar">
            <div class="nav-item active" onclick="showSection('identity', event)">üîê Nostr Identity</div>
            <div class="nav-item" onclick="showSection('wallet', event)">üí∞ Wallet</div>
            <div class="nav-item" onclick="showSection('keypackages', event)">üîë Key Packages</div>
            <div class="nav-item" onclick="showSection('groups', event)">üì± Groups</div>
        </div>

        <!-- Content Area -->
        <div id="content">
            <!-- Identity Section -->
            <div id="identity-section" class="section active">
                <h2>Nostr Identity</h2>
                <div id="status">Loading WASM module...</div>
                <div id="npub-container" style="display: none;">
                    <p><strong>Your npub:</strong></p>
                    <div class="npub" id="npub"></div>
                </div>
                <div id="buttons" style="display: none;">
                    <button onclick="newKeys()">Generate New Keys</button>
                    <button onclick="clearKeys()">Clear Keys</button>
                </div>
            </div>

            <!-- Wallet Section -->
            <div id="wallet-section" class="section">
                <h2>üí∞ Wallet</h2>
                <p>Mint: <code>https://nofees.testnut.cashu.space</code></p>
                <p style="margin-top: 10px;">Balance: <strong><span id="balance">0</span> sats</strong></p>
                <div id="wallet-status">Initializing wallet...</div>
                <button onclick="showReceiveModal()">Receive e-cash</button>
            </div>

            <!-- Key Packages Section -->
            <div id="keypackages-section" class="section">
                <h2>üîë Join a Group</h2>
                <p>Click the button below to create a KeyPackage and wait for someone to invite you to a group.</p>
                <button onclick="createKeyPackageAndWait()">üöÄ Create KeyPackage & Wait for Invite</button>
                <div id="keypackages-status" style="margin-top: 20px;"></div>
            </div>

            <!-- Groups Section -->
            <div id="groups-section" class="section">
                <h2>üì± Groups</h2>
                <div id="groups-status">Loading groups...</div>
                <div id="groups-list"></div>
                <button onclick="showCreateGroupModal()">‚ûï Create New Group</button>
                <button onclick="refreshGroups()">Refresh Groups</button>
                <button onclick="processWelcomes()">Check for Invites</button>
            </div>

            <!-- Chat Section -->
            <div id="chat-section" class="section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="chat-group-name">üí¨ Chat</h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="showInviteModal()">‚ûï Invite Member</button>
                        <button onclick="closeChat()">‚Üê Back to Groups</button>
                    </div>
                </div>
                <div id="chat-messages" style="height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background: #f9f9f9;">
                    <p style="color: #666;">Loading messages...</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chat-input" placeholder="Type a message..." style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    <button onclick="sendChatMessage()" style="padding: 10px 20px;">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receive Modal -->
    <div id="receive-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; max-width: 600px; margin: 50px auto; padding: 20px; border-radius: 8px;">
            <h2>Receive e-cash Token</h2>
            <p>Paste your Cashu token below:</p>
            <textarea id="token-input" rows="6" style="width: 100%; font-family: monospace; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            <div style="margin-top: 10px;">
                <button onclick="receiveToken()">Receive</button>
                <button onclick="hideReceiveModal()">Cancel</button>
            </div>
            <div id="receive-status" style="margin-top: 10px;"></div>
        </div>
    </div>

    <!-- Wait for Invite Modal -->
    <div id="wait-invite-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
        <div style="background: white; max-width: 700px; margin: 50px auto; padding: 30px; border-radius: 8px; text-align: center;">
            <h2>‚è≥ Waiting for Group Invite</h2>
            <p style="margin: 20px 0;">Your KeyPackage is being published!</p>
            <div class="npub" id="wait-npub" style="margin: 20px 0;"></div>
            <div id="wait-status" style="margin: 20px 0; font-weight: bold; color: #0066cc;"></div>

            <!-- Relay Status -->
            <div id="wait-relay-status" style="margin: 20px auto; max-width: 500px; text-align: left; font-size: 0.9em; max-height: 200px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 4px; display: none;">
                <div style="font-weight: bold; margin-bottom: 5px; text-align: center;">Relay Status:</div>
                <div id="wait-relay-list"></div>
            </div>

            <p style="color: #666; margin: 20px 0;" id="wait-instruction">Waiting for someone to invite you to a group...</p>
            <div style="margin-top: 20px;">
                <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0066cc; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="create-group-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; max-width: 500px; margin: 100px auto; padding: 30px; border-radius: 8px;">
            <h2>‚ûï Create New Group</h2>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Group Name:</label>
                <input type="text" id="create-group-name" placeholder="My Group" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Description (optional):</label>
                <textarea id="create-group-description" placeholder="What's this group about?" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; min-height: 60px;"></textarea>
            </div>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">First member to invite:</label>
                <input type="text" id="create-group-first-member" placeholder="npub1..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 0.9em;">
                <p style="font-size: 0.9em; color: #666; margin-top: 5px;">Groups require you and at least 1 other member. You can invite more people later.</p>
            </div>
            <div id="create-group-status" style="margin: 20px 0; color: #0066cc;"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="createGroup()" style="flex: 1; padding: 12px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em;">Create Group</button>
                <button onclick="closeCreateGroupModal()" style="padding: 12px 30px; background: #ccc; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Invite Member Modal -->
    <div id="invite-member-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; max-width: 500px; margin: 100px auto; padding: 30px; border-radius: 8px;">
            <h2>‚ûï Invite Member to Group</h2>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Member's npub:</label>
                <input type="text" id="invite-member-npub" placeholder="npub1abc..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 0.9em;">
                <p style="font-size: 0.9em; color: #666; margin-top: 5px;">Enter the npub of the person you want to invite</p>
            </div>
            <div id="invite-member-status" style="margin: 20px 0; color: #0066cc;"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="inviteMember()" style="flex: 1; padding: 12px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em;">Send Invite</button>
                <button onclick="closeInviteModal()" style="padding: 12px 30px; background: #ccc; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script type="module">
        // ==========================================
        // TAB LOCK MECHANISM
        // ==========================================
        const LOCK_KEY = 'mdk_tab_lock';
        const LOCK_HEARTBEAT_INTERVAL = 2000; // 2 seconds
        const LOCK_STALE_TIMEOUT = 5000; // 5 seconds

        let hasLock = false;
        let heartbeatInterval = null;
        let lockCheckInterval = null;

        function acquireLock() {
            const now = Date.now();
            const lockData = localStorage.getItem(LOCK_KEY);

            if (lockData) {
                try {
                    const lock = JSON.parse(lockData);
                    const age = now - lock.timestamp;

                    // If lock is fresh (< 5 sec), another tab owns it
                    if (age < LOCK_STALE_TIMEOUT) {
                        return false;
                    }
                    // Lock is stale, we can take it
                    console.log('Lock was stale, taking over');
                } catch (e) {
                    console.error('Failed to parse lock data:', e);
                }
            }

            // Acquire the lock
            const lockInfo = {
                timestamp: now,
                tabId: Math.random().toString(36).substring(7)
            };
            localStorage.setItem(LOCK_KEY, JSON.stringify(lockInfo));
            hasLock = true;
            console.log('üîí Lock acquired');
            return true;
        }

        function updateHeartbeat() {
            if (!hasLock) return;

            const now = Date.now();
            const lockInfo = {
                timestamp: now,
                tabId: 'current'
            };
            localStorage.setItem(LOCK_KEY, JSON.stringify(lockInfo));
        }

        function releaseLock() {
            if (hasLock) {
                localStorage.removeItem(LOCK_KEY);
                hasLock = false;
                console.log('üîì Lock released');
            }
        }

        function showLockWarning() {
            document.body.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #f5f5f5; font-family: Arial, sans-serif;">
                    <div style="text-align: center; padding: 40px; max-width: 600px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="font-size: 4em; margin-bottom: 20px;">üëã</div>
                        <h2 style="color: #333; margin-bottom: 20px; font-weight: normal;">Already open in another tab</h2>
                        <p style="font-size: 1.1em; color: #666; margin-bottom: 20px; line-height: 1.6;">
                            You've already got this app running somewhere else. To keep your wallet and messages safe,
                            please use that tab instead.
                        </p>
                        <p style="font-size: 0.95em; color: #888; margin-top: 30px; line-height: 1.6;">
                            If you closed the other tab, just wait a moment and <a href="#" onclick="location.reload()" style="color: #0066cc; text-decoration: none; border-bottom: 1px solid #0066cc;">click here to reload</a>.
                        </p>
                    </div>
                </div>
            `;
        }

        // Try to acquire lock on load
        if (!acquireLock()) {
            showLockWarning();
            throw new Error('Cannot start - app already open in another tab');
        }

        // Send heartbeats
        heartbeatInterval = setInterval(updateHeartbeat, LOCK_HEARTBEAT_INTERVAL);

        // Release lock on unload
        window.addEventListener('beforeunload', () => {
            releaseLock();
        });

        // Listen for storage events (another tab released lock)
        window.addEventListener('storage', (e) => {
            if (e.key === LOCK_KEY) {
                if (!hasLock) {
                    // We don't have lock, check if we can acquire it now
                    if (e.newValue === null || e.newValue === '') {
                        // Lock was released, try to acquire
                        setTimeout(() => {
                            if (acquireLock()) {
                                location.reload();
                            }
                        }, 100);
                    }
                }
            }
        });

        // Periodically check if we still have the lock
        lockCheckInterval = setInterval(() => {
            if (hasLock) {
                const lockData = localStorage.getItem(LOCK_KEY);
                if (!lockData) {
                    console.error('Lock was lost!');
                    hasLock = false;
                    showLockWarning();
                    clearInterval(heartbeatInterval);
                    clearInterval(lockCheckInterval);
                }
            }
        }, 1000);

        // ==========================================
        // END TAB LOCK MECHANISM
        // ==========================================

        import init, {
            get_or_create_keys,
            generate_keys,
            get_npub,
            clear_keys,
            init_wallet,
            get_balance,
            receive_token,
            parse_token_info,
            get_groups,
            fetch_welcome_events,
            process_pending_welcomes,
            create_keypackage_and_wait_for_invite,
            create_group_with_members,
            invite_member_to_group,
            send_message_to_group,
            get_messages_for_group,
            subscribe_to_group_messages,
            log
        } from './pkg/mdk_ecash_web.js';

        let wasm;

        // Navigation
        window.showSection = function(sectionName, event, skipHashUpdate = false) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            // Also hide chat section (uses inline display style)
            document.getElementById('chat-section').style.display = 'none';

            // Show selected section
            document.getElementById(`${sectionName}-section`).classList.add('active');

            // Mark the nav item as active (if called from nav click)
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Called programmatically, find and activate the nav item
                const navItem = Array.from(document.querySelectorAll('.nav-item'))
                    .find(item => item.getAttribute('onclick')?.includes(`'${sectionName}'`));
                if (navItem) {
                    navItem.classList.add('active');
                }
            }

            // Load content if needed
            if (sectionName === 'groups') {
                refreshGroups();
            }

            // Update URL hash (unless we're restoring from hash)
            if (!skipHashUpdate) {
                window.location.hash = sectionName;
            }
        };

        async function loadWasm() {
            try {
                wasm = await init();
                log("WASM module loaded successfully");
                await displayNpub();
                await initializeWallet();
                await initializeGroups();
                document.getElementById('buttons').style.display = 'block';
                document.getElementById('status').innerHTML = '<div class="success">‚úì Ready</div>';

                // Restore state from URL hash
                await restoreFromHash();
            } catch (err) {
                console.error('Failed to load WASM:', err);
                document.getElementById('status').innerHTML =
                    `<div class="error">Failed to load WASM: ${err}</div>`;
            }
        }

        // Restore state from URL hash
        async function restoreFromHash() {
            const hash = window.location.hash.slice(1); // Remove leading #
            if (!hash) return;

            if (hash.startsWith('chat:')) {
                // Format: chat:groupId:groupName
                const parts = hash.split(':');
                if (parts.length >= 3) {
                    const groupId = parts[1];
                    const groupName = decodeURIComponent(parts.slice(2).join(':'));
                    await openChat(groupId, groupName, true); // skipHashUpdate=true
                }
            } else {
                // Regular section like 'wallet', 'groups', etc.
                if (document.getElementById(`${hash}-section`)) {
                    showSection(hash, null, true); // skipHashUpdate=true
                }
            }
        }

        // Listen for hash changes (browser back/forward)
        window.addEventListener('hashchange', async () => {
            await restoreFromHash();
        });

        async function initializeWallet() {
            try {
                document.getElementById('wallet-status').textContent = 'Initializing wallet...';

                const balance = await init_wallet();
                document.getElementById('balance').textContent = balance;
                document.getElementById('wallet-status').innerHTML = '<div class="success">‚úì Wallet ready</div>';
                log("Wallet initialized with balance: " + balance);
            } catch (err) {
                console.error('Failed to initialize wallet:', err);
                document.getElementById('wallet-status').innerHTML =
                    `<div class="error">Failed to initialize wallet: ${err}</div>`;
            }
        }

        async function initializeGroups() {
            await refreshGroups();
        }

        window.refreshGroups = async function() {
            try {
                console.log('üîÑ Refreshing groups list...');
                document.getElementById('groups-status').textContent = 'Loading groups...';

                const groupsJson = await get_groups();
                console.log('  Received groups JSON:', groupsJson);
                const groups = JSON.parse(groupsJson);
                console.log(`  Parsed ${groups.length} group(s)`);

                const listDiv = document.getElementById('groups-list');
                if (groups.length === 0) {
                    listDiv.innerHTML = '<p style="color: #666;">No groups yet. Accept an invite to get started!</p>';
                    document.getElementById('groups-status').innerHTML = '<div class="success">‚úì Ready (0 groups)</div>';
                } else {
                    listDiv.innerHTML = groups.map(group => {
                        console.log(`  Rendering group: ${group.name || 'Unnamed'} (ID: ${group.id})`);
                        const lastMessage = group.last_message_at
                            ? new Date(group.last_message_at * 1000).toLocaleString()
                            : 'No messages yet';
                        const memberCount = group.member_count || 0;
                        return `
                        <div class="group-item" onclick="openChat('${group.id}', '${(group.name || 'Unnamed Group').replace(/'/g, "\\'")}')" style="cursor: pointer; padding: 15px; border-bottom: 1px solid #eee; transition: background 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                            <div>
                                <strong style="font-size: 1.1em;">${group.name || 'Unnamed Group'}</strong>
                                <span style="color: #666; font-size: 0.9em; margin-left: 10px;">üë• ${memberCount} member${memberCount !== 1 ? 's' : ''}</span>
                                <br>
                                <small style="color: #666;">${group.description || 'No description'}</small><br>
                                <small style="color: #999;">Last activity: ${lastMessage}</small>
                            </div>
                        </div>`;
                    }).join('');
                    document.getElementById('groups-status').innerHTML =
                        `<div class="success">‚úì Found ${groups.length} group(s)</div>`;
                }

                console.log(`‚úÖ Groups list refreshed (${groups.length} group(s))`);
                log(`Loaded ${groups.length} group(s)`);
            } catch (err) {
                console.error('‚ùå Failed to fetch groups:', err);
                document.getElementById('groups-status').innerHTML =
                    `<div class="error">Failed to load: ${err}</div>`;
            }
        };

        window.processWelcomes = async function() {
            const statusDiv = document.getElementById('groups-status');
            statusDiv.innerHTML = 'Checking for new group invites...';

            try {
                // Step 1: Fetch Welcome events from Nostr relays
                statusDiv.innerHTML = 'Fetching invites from Nostr relays...';
                const fetched = await fetch_welcome_events();
                log(`Fetched and processed ${fetched} Welcome event(s)`);

                // Step 2: Auto-accept any pending welcomes
                statusDiv.innerHTML = 'Processing invites...';
                const count = await process_pending_welcomes();

                if (count > 0) {
                    statusDiv.innerHTML = `<div class="success">‚úÖ Joined ${count} new group(s)!</div>`;
                    // Refresh groups list
                    await refreshGroups();
                } else {
                    statusDiv.innerHTML = '<div class="success">No new invites found</div>';
                }
            } catch (err) {
                console.error('Failed to process welcomes:', err);
                statusDiv.innerHTML = `<div class="error">Failed to process invites: ${err}</div>`;
            }
        };

        // Chat interface variables
        let currentChatGroupId = null;
        let currentChatGroupName = null;

        window.openChat = async function(groupId, groupName, skipHashUpdate = false) {
            console.log(`üí¨ Opening chat for group: ${groupName} (${groupId})`);

            // Store current group info
            currentChatGroupId = groupId;
            currentChatGroupName = groupName;

            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

            // Update UI and show chat
            document.getElementById('chat-group-name').textContent = `üí¨ ${groupName}`;
            document.getElementById('chat-section').style.display = 'block';

            // Update URL hash (encode groupName to handle special characters) unless we're restoring from hash
            if (!skipHashUpdate) {
                window.location.hash = `chat:${groupId}:${encodeURIComponent(groupName)}`;
            }

            // Load messages
            await loadMessages(groupId);

            // Subscribe to new messages
            await subscribe_to_group_messages(groupId, async (message) => {
                console.log('üì® New message received:', message);
                await addMessageToChat(message);
            });
        };

        window.closeChat = function() {
            console.log('‚Üê Closing chat');
            currentChatGroupId = null;
            currentChatGroupName = null;
            showSection('groups');
        };

        // Store tokens by ID for redemption
        const tokenStore = new Map();
        let tokenIdCounter = 0;

        // Format message content, detecting and formatting Cashu tokens
        async function formatMessageContent(content) {
            // Detect cashu tokens (start with cashuA or cashuB)
            const tokenRegex = /cashu[AB][A-Za-z0-9_-]+/g;
            const tokens = content.match(tokenRegex);

            if (!tokens) {
                return content;
            }

            let formattedContent = content;

            for (const token of tokens) {
                try {
                    const infoJson = await parse_token_info(token);
                    const info = JSON.parse(infoJson);

                    // Extract just the hostname from the mint URL
                    let mintDisplay = info.mint;
                    try {
                        const url = new URL(info.mint);
                        mintDisplay = url.hostname;
                    } catch (e) {
                        // If URL parsing fails, use the full string
                    }

                    // Store token for redemption
                    const tokenId = `token-${tokenIdCounter++}`;
                    tokenStore.set(tokenId, token);

                    const tokenHtml = `<span style="background: #ff8800; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; display: inline-block; margin: 2px 0;">
                        ${info.amount} sats @ ${mintDisplay}
                        <button id="${tokenId}" onclick="redeemToken('${tokenId}')" style="background: white; color: #ff8800; border: none; padding: 2px 6px; margin-left: 4px; border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 0.9em;">Redeem</button>
                    </span>`;
                    formattedContent = formattedContent.replace(token, tokenHtml);
                } catch (e) {
                    console.error('Failed to parse token:', e);
                    // Leave the token as-is if parsing fails
                }
            }

            return formattedContent;
        }

        window.redeemToken = async function(tokenId) {
            const token = tokenStore.get(tokenId);
            if (!token) {
                alert('Token not found');
                return;
            }

            const button = document.getElementById(tokenId);
            if (!button) return;

            // Disable button during redemption
            button.disabled = true;
            button.textContent = 'Redeeming...';

            try {
                console.log('üí∞ Redeeming token...');
                const amount = await receive_token(token);
                console.log(`‚úÖ Redeemed ${amount} sats!`);

                // Update button to show success
                button.textContent = 'Redeemed ‚úì';
                button.style.background = '#4CAF50';
                button.style.color = 'white';

                // Update wallet balance
                const newBalance = await get_balance();
                document.getElementById('balance').textContent = newBalance;

                // Remove token from store
                tokenStore.delete(tokenId);

                alert(`Successfully redeemed ${amount} sats!`);
            } catch (err) {
                console.error('‚ùå Failed to redeem token:', err);
                button.disabled = false;
                button.textContent = 'Redeem';
                alert(`Failed to redeem token: ${err}`);
            }
        };

        async function loadMessages(groupId) {
            try {
                document.getElementById('chat-messages').innerHTML = '<p style="color: #666;">Loading messages...</p>';

                const messagesJson = await get_messages_for_group(groupId);
                const messages = JSON.parse(messagesJson);

                console.log(`üì¨ Loaded ${messages.length} message(s)`);

                const chatDiv = document.getElementById('chat-messages');
                if (messages.length === 0) {
                    chatDiv.innerHTML = '<p style="color: #666;">No messages yet. Be the first to send one!</p>';
                } else {
                    // Format all messages
                    const formattedMessages = await Promise.all(messages.map(async msg => {
                        const timestamp = new Date(msg.created_at * 1000).toLocaleTimeString();
                        const npub = msg.pubkey.substring(0, 16);
                        const formattedContent = await formatMessageContent(msg.content);
                        return `
                        <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px;">
                            <div style="font-size: 0.85em; color: #666; margin-bottom: 4px;">
                                <strong>${npub}...</strong> ‚Ä¢ ${timestamp}
                            </div>
                            <div>${formattedContent}</div>
                        </div>`;
                    }));

                    chatDiv.innerHTML = formattedMessages.join('');
                }

                // Scroll to bottom
                chatDiv.scrollTop = chatDiv.scrollHeight;
            } catch (err) {
                console.error('‚ùå Failed to load messages:', err);
                document.getElementById('chat-messages').innerHTML =
                    `<p style="color: red;">Failed to load messages: ${err}</p>`;
            }
        }

        async function addMessageToChat(message) {
            const chatDiv = document.getElementById('chat-messages');

            // Remove "no messages" text if present
            if (chatDiv.querySelector('p')) {
                chatDiv.innerHTML = '';
            }

            const timestamp = new Date(message.created_at * 1000).toLocaleTimeString();
            const npub = message.pubkey.substring(0, 16);
            const formattedContent = await formatMessageContent(message.content);

            const messageHtml = `
            <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px;">
                <div style="font-size: 0.85em; color: #666; margin-bottom: 4px;">
                    <strong>${npub}...</strong> ‚Ä¢ ${timestamp}
                </div>
                <div>${formattedContent}</div>
            </div>`;

            chatDiv.innerHTML += messageHtml;

            // Scroll to bottom
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        window.sendChatMessage = async function() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) {
                return;
            }

            if (!currentChatGroupId) {
                alert('No group selected');
                return;
            }

            try {
                console.log(`üì§ Sending message: "${message}"`);
                await send_message_to_group(currentChatGroupId, message);
                console.log('‚úÖ Message sent');

                // Clear input
                input.value = '';

                // Message will appear via subscription when relay broadcasts it back
            } catch (err) {
                console.error('‚ùå Failed to send message:', err);
                alert(`Failed to send message: ${err}`);
            }
        };

        // Allow Enter key to send message
        window.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
        });

        async function displayNpub() {
            try {
                const npub = get_or_create_keys();
                document.getElementById('npub').textContent = npub;
                document.getElementById('npub-container').style.display = 'block';
            } catch (err) {
                console.error('Failed to get npub:', err);
                document.getElementById('status').innerHTML =
                    `<div class="error">Failed to get keys: ${err}</div>`;
            }
        }

        window.newKeys = async function() {
            try {
                const npub = generate_keys();
                document.getElementById('npub').textContent = npub;
                log("New keys generated: " + npub);
                alert('New keys generated! Previous keys are overwritten.');
            } catch (err) {
                console.error('Failed to generate keys:', err);
                alert('Failed to generate keys: ' + err);
            }
        };

        window.clearKeys = async function() {
            if (confirm('Are you sure you want to clear your keys? This cannot be undone!')) {
                try {
                    clear_keys();
                    document.getElementById('npub-container').style.display = 'none';
                    document.getElementById('status').innerHTML =
                        '<div class="success">Keys cleared. Reload page to generate new keys.</div>';
                } catch (err) {
                    console.error('Failed to clear keys:', err);
                    alert('Failed to clear keys: ' + err);
                }
            }
        };

        window.showReceiveModal = function() {
            document.getElementById('receive-modal').style.display = 'block';
            document.getElementById('token-input').value = '';
            document.getElementById('receive-status').innerHTML = '';
        };

        window.hideReceiveModal = function() {
            document.getElementById('receive-modal').style.display = 'none';
        };

        window.receiveToken = async function() {
            const tokenInput = document.getElementById('token-input').value.trim();
            const statusDiv = document.getElementById('receive-status');

            if (!tokenInput) {
                statusDiv.innerHTML = '<div class="error">Please paste a token</div>';
                return;
            }

            statusDiv.innerHTML = 'Receiving token...';

            try {
                const amount = await receive_token(tokenInput);
                statusDiv.innerHTML = `<div class="success">‚úÖ Received ${amount} sats!</div>`;

                // Update balance display
                const newBalance = await get_balance();
                document.getElementById('balance').textContent = newBalance;

                // Close modal after 2 seconds
                setTimeout(() => {
                    hideReceiveModal();
                }, 2000);
            } catch (err) {
                console.error('Failed to receive token:', err);
                statusDiv.innerHTML = `<div class="error">Failed to receive: ${err}</div>`;
            }
        };

        // Intercept console.log to show relay status
        const originalLog = console.log;
        let relayStatusCapture = false;

        console.log = function(...args) {
            originalLog.apply(console, args);

            if (relayStatusCapture && args.length > 0) {
                const message = args[0].toString();

                // Check for relay accept/reject messages
                if (message.includes('‚úì') && message.includes('accepted')) {
                    const relayList = document.getElementById('wait-relay-list');
                    if (relayList) {
                        document.getElementById('wait-relay-status').style.display = 'block';
                        const relay = message.replace(/^\s+‚úì\s+/, '').replace(' accepted', '');
                        relayList.innerHTML += `<div style="color: green; padding: 2px 0;">‚úì ${relay}</div>`;
                    }
                } else if (message.includes('‚úó') && message.includes('rejected')) {
                    const relayList = document.getElementById('wait-relay-list');
                    if (relayList) {
                        document.getElementById('wait-relay-status').style.display = 'block';
                        const parts = message.replace(/^\s+‚úó\s+/, '').split(' rejected: ');
                        const relay = parts[0];
                        const error = parts[1] || 'unknown error';
                        relayList.innerHTML += `<div style="color: #ff6600; padding: 2px 0;">‚úó ${relay}: ${error}</div>`;
                    }
                }
            }
        };

        window.createKeyPackageAndWait = async function() {
            try {
                // Reset and show modal
                document.getElementById('wait-invite-modal').style.display = 'block';
                document.getElementById('wait-npub').textContent = get_npub();
                document.getElementById('wait-status').textContent = 'Creating KeyPackage...';
                document.getElementById('wait-relay-list').innerHTML = '';
                document.getElementById('wait-relay-status').style.display = 'none';

                // Start capturing relay status
                relayStatusCapture = true;

                // Call the WASM function (it will poll and wait)
                const groupName = await create_keypackage_and_wait_for_invite();

                // Stop capturing
                relayStatusCapture = false;

                // Success!
                document.getElementById('wait-status').innerHTML = `<div class="success">‚úÖ Joined group: ${groupName}</div>`;

                // Wait 2 seconds then close modal and refresh groups
                setTimeout(async () => {
                    document.getElementById('wait-invite-modal').style.display = 'none';
                    await refreshGroups();
                    // Switch to groups tab
                    showSection('groups');
                }, 2000);
            } catch (err) {
                console.error('Failed to join group:', err);
                relayStatusCapture = false;
                document.getElementById('wait-status').innerHTML = `<div class="error">Failed: ${err}</div>`;
                setTimeout(() => {
                    document.getElementById('wait-invite-modal').style.display = 'none';
                }, 3000);
            }
        };

        // Create Group Modal
        window.showCreateGroupModal = function() {
            document.getElementById('create-group-modal').style.display = 'block';
            document.getElementById('create-group-name').value = '';
            document.getElementById('create-group-description').value = '';
            document.getElementById('create-group-first-member').value = '';
            document.getElementById('create-group-status').innerHTML = '';
        };

        window.closeCreateGroupModal = function() {
            document.getElementById('create-group-modal').style.display = 'none';
        };

        window.createGroup = async function() {
            const name = document.getElementById('create-group-name').value.trim();
            const description = document.getElementById('create-group-description').value.trim();
            const firstMember = document.getElementById('create-group-first-member').value.trim();

            if (!name) {
                alert('Please enter a group name');
                return;
            }

            if (!firstMember) {
                alert('Please enter at least one member to invite');
                return;
            }

            if (!firstMember.startsWith('npub1')) {
                alert('Invalid npub format. Must start with npub1');
                return;
            }

            const statusDiv = document.getElementById('create-group-status');
            statusDiv.textContent = 'Creating group...';

            try {
                console.log(`Creating group "${name}" with first member: ${firstMember.substring(0, 16)}...`);

                // Call WASM function with first member
                const groupId = await create_group_with_members(name, description, JSON.stringify([firstMember]));

                statusDiv.innerHTML = `<div class="success">‚úÖ Group created!<br><small>Use "Invite Member" to add more people.</small></div>`;

                // Wait a moment then close and refresh
                setTimeout(async () => {
                    closeCreateGroupModal();
                    await refreshGroups();
                    showSection('groups');
                }, 2000);
            } catch (err) {
                console.error('Failed to create group:', err);
                statusDiv.innerHTML = `<div class="error">Failed: ${err}</div>`;
            }
        };

        // Invite Member Modal
        let currentGroupIdForInvite = null;

        window.showInviteModal = function() {
            // Store the current group ID
            currentGroupIdForInvite = currentChatGroupId;
            document.getElementById('invite-member-modal').style.display = 'block';
            document.getElementById('invite-member-npub').value = '';
            document.getElementById('invite-member-status').innerHTML = '';
        };

        window.closeInviteModal = function() {
            document.getElementById('invite-member-modal').style.display = 'none';
            currentGroupIdForInvite = null;
        };

        window.inviteMember = async function() {
            const npub = document.getElementById('invite-member-npub').value.trim();

            if (!npub) {
                alert('Please enter an npub');
                return;
            }

            if (!npub.startsWith('npub1')) {
                alert('Invalid npub format. Must start with npub1');
                return;
            }

            if (!currentGroupIdForInvite) {
                alert('No group selected');
                return;
            }

            const statusDiv = document.getElementById('invite-member-status');
            statusDiv.textContent = 'Sending invite...';

            try {
                // Call WASM function
                await invite_member_to_group(currentGroupIdForInvite, npub);

                statusDiv.innerHTML = `<div class="success">‚úÖ Invite sent!</div>`;

                // Wait a moment then close
                setTimeout(() => {
                    closeInviteModal();
                }, 1500);
            } catch (err) {
                console.error('Failed to invite member:', err);
                statusDiv.innerHTML = `<div class="error">Failed: ${err}</div>`;
            }
        };

        // Load WASM on page load
        loadWasm();
    </script>
</body>
</html>
