<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDK Ecash Web Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .npub {
            font-family: monospace;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0052a3;
        }
        .error {
            color: red;
            padding: 10px;
            background: #ffe6e6;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: green;
            padding: 10px;
            background: #e6ffe6;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîê MDK Ecash Web Client</h1>

    <div class="card">
        <h2>Nostr Identity</h2>
        <div id="status">Loading WASM module...</div>
        <div id="npub-container" style="display: none;">
            <p><strong>Your npub:</strong></p>
            <div class="npub" id="npub"></div>
        </div>
        <div id="buttons" style="display: none;">
            <button onclick="newKeys()">Generate New Keys</button>
            <button onclick="clearKeys()">Clear Keys</button>
        </div>
    </div>

    <div class="card" id="wallet-card" style="display: none;">
        <h2>üí∞ Wallet</h2>
        <p>Mint: <code>https://nofees.testnut.cashu.space</code></p>
        <p>Balance: <span id="balance">0</span> sats</p>
        <div id="wallet-status">Initializing wallet...</div>
        <button onclick="showReceiveModal()">Receive e-cash</button>
    </div>

    <div class="card" id="mdk-card" style="display: none;">
        <h2>üîê MDK Storage</h2>
        <div id="mdk-status">Not initialized</div>
        <button onclick="initMdk()">Initialize MDK</button>
    </div>

    <!-- Receive Modal -->
    <div id="receive-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; max-width: 600px; margin: 50px auto; padding: 20px; border-radius: 8px;">
            <h2>Receive e-cash Token</h2>
            <p>Paste your Cashu token below:</p>
            <textarea id="token-input" rows="6" style="width: 100%; font-family: monospace; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            <div style="margin-top: 10px;">
                <button onclick="receiveToken()">Receive</button>
                <button onclick="hideReceiveModal()">Cancel</button>
            </div>
            <div id="receive-status" style="margin-top: 10px;"></div>
        </div>
    </div>

    <script type="module">
        import init, {
            get_or_create_keys,
            generate_keys,
            get_npub,
            clear_keys,
            init_wallet,
            get_balance,
            receive_token,
            init_mdk_storage,
            log
        } from './pkg/mdk_ecash_web.js';

        let wasm;

        async function loadWasm() {
            try {
                wasm = await init();
                log("WASM module loaded successfully");
                await displayNpub();
                await initializeWallet();
                await initializeMdk();
                document.getElementById('buttons').style.display = 'block';
                document.getElementById('mdk-card').style.display = 'block';
                document.getElementById('status').innerHTML = '<div class="success">‚úì Ready</div>';
            } catch (err) {
                console.error('Failed to load WASM:', err);
                document.getElementById('status').innerHTML =
                    `<div class="error">Failed to load WASM: ${err}</div>`;
            }
        }

        async function initializeWallet() {
            try {
                document.getElementById('wallet-card').style.display = 'block';
                document.getElementById('wallet-status').textContent = 'Initializing wallet...';

                const balance = await init_wallet();
                document.getElementById('balance').textContent = balance;
                document.getElementById('wallet-status').innerHTML = '<div class="success">‚úì Wallet ready</div>';
                log("Wallet initialized with balance: " + balance);
            } catch (err) {
                console.error('Failed to initialize wallet:', err);
                document.getElementById('wallet-status').innerHTML =
                    `<div class="error">Failed to initialize wallet: ${err}</div>`;
            }
        }

        async function initializeMdk() {
            try {
                document.getElementById('mdk-status').textContent = 'Initializing MDK storage...';

                await init_mdk_storage();
                document.getElementById('mdk-status').innerHTML = '<div class="success">‚úì MDK storage ready</div>';
                log("MDK storage initialized");
            } catch (err) {
                console.error('Failed to initialize MDK:', err);
                document.getElementById('mdk-status').innerHTML =
                    `<div class="error">Failed to initialize MDK: ${err}</div>`;
            }
        }

        async function displayNpub() {
            try {
                const npub = get_or_create_keys();
                document.getElementById('npub').textContent = npub;
                document.getElementById('npub-container').style.display = 'block';
            } catch (err) {
                console.error('Failed to get npub:', err);
                document.getElementById('status').innerHTML =
                    `<div class="error">Failed to get keys: ${err}</div>`;
            }
        }

        window.newKeys = async function() {
            try {
                const npub = generate_keys();
                document.getElementById('npub').textContent = npub;
                log("New keys generated: " + npub);
                alert('New keys generated! Previous keys are overwritten.');
            } catch (err) {
                console.error('Failed to generate keys:', err);
                alert('Failed to generate keys: ' + err);
            }
        };

        window.clearKeys = async function() {
            if (confirm('Are you sure you want to clear your keys? This cannot be undone!')) {
                try {
                    clear_keys();
                    document.getElementById('npub-container').style.display = 'none';
                    document.getElementById('status').innerHTML =
                        '<div class="success">Keys cleared. Reload page to generate new keys.</div>';
                } catch (err) {
                    console.error('Failed to clear keys:', err);
                    alert('Failed to clear keys: ' + err);
                }
            }
        };

        window.showReceiveModal = function() {
            document.getElementById('receive-modal').style.display = 'block';
            document.getElementById('token-input').value = '';
            document.getElementById('receive-status').innerHTML = '';
        };

        window.hideReceiveModal = function() {
            document.getElementById('receive-modal').style.display = 'none';
        };

        window.receiveToken = async function() {
            const tokenInput = document.getElementById('token-input').value.trim();
            const statusDiv = document.getElementById('receive-status');

            if (!tokenInput) {
                statusDiv.innerHTML = '<div class="error">Please paste a token</div>';
                return;
            }

            statusDiv.innerHTML = 'Receiving token...';

            try {
                const amount = await receive_token(tokenInput);
                statusDiv.innerHTML = `<div class="success">‚úÖ Received ${amount} sats!</div>`;

                // Update balance display
                const newBalance = await get_balance();
                document.getElementById('balance').textContent = newBalance;

                // Close modal after 2 seconds
                setTimeout(() => {
                    hideReceiveModal();
                }, 2000);
            } catch (err) {
                console.error('Failed to receive token:', err);
                statusDiv.innerHTML = `<div class="error">Failed to receive: ${err}</div>`;
            }
        };

        window.initMdk = async function() {
            const statusDiv = document.getElementById('mdk-status');
            statusDiv.innerHTML = 'Initializing MDK storage...';

            try {
                await init_mdk_storage();
                statusDiv.innerHTML = '<div class="success">‚úÖ MDK storage initialized and persisted!</div>';
                log('MDK storage ready. Check localStorage for mdk_state');
            } catch (err) {
                console.error('Failed to initialize MDK:', err);
                statusDiv.innerHTML = `<div class="error">Failed to initialize: ${err}</div>`;
            }
        };

        // Load WASM on page load
        loadWasm();
    </script>
</body>
</html>
