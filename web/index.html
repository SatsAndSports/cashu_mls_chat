<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDK Ecash Web Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #header {
            background: #0066cc;
            color: white;
            padding: 15px 20px;
            font-size: 1.2em;
        }
        #main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        #sidebar {
            width: 250px;
            background: #f5f5f5;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }
        .nav-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
            transition: background 0.2s;
        }
        .nav-item:hover {
            background: #e6e6e6;
        }
        .nav-item.active {
            background: white;
            border-left: 3px solid #0066cc;
            padding-left: 17px;
        }
        #content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .npub {
            font-family: monospace;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
            margin: 10px 0;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
        }
        button:hover {
            background: #0052a3;
        }
        .error {
            color: red;
            padding: 10px;
            background: #ffe6e6;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: green;
            padding: 10px;
            background: #e6ffe6;
            border-radius: 4px;
            margin: 10px 0;
        }
        .group-item {
            padding: 10px;
            background: #f5f5f5;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .group-item:hover {
            background: #e6e6e6;
        }
        .group-item.active {
            background: #0066cc;
            color: white;
        }
    </style>
</head>
<body>
    <div id="header">üîê MDK Ecash Web Client</div>

    <div id="main">
        <!-- Sidebar -->
        <div id="sidebar">
            <div class="nav-item active" onclick="showSection('identity')">üîê Nostr Identity</div>
            <div class="nav-item" onclick="showSection('wallet')">üí∞ Wallet</div>
            <div class="nav-item" onclick="showSection('keypackages')">üîë Key Packages</div>
            <div class="nav-item" onclick="showSection('groups')">üì± Groups</div>
        </div>

        <!-- Content Area -->
        <div id="content">
            <!-- Identity Section -->
            <div id="identity-section" class="section active">
                <h2>Nostr Identity</h2>
                <div id="status">Loading WASM module...</div>
                <div id="npub-container" style="display: none;">
                    <p><strong>Your npub:</strong></p>
                    <div class="npub" id="npub"></div>
                </div>
                <div id="buttons" style="display: none;">
                    <button onclick="newKeys()">Generate New Keys</button>
                    <button onclick="clearKeys()">Clear Keys</button>
                </div>
            </div>

            <!-- Wallet Section -->
            <div id="wallet-section" class="section">
                <h2>üí∞ Wallet</h2>
                <p>Mint: <code>https://nofees.testnut.cashu.space</code></p>
                <p style="margin-top: 10px;">Balance: <strong><span id="balance">0</span> sats</strong></p>
                <div id="wallet-status">Initializing wallet...</div>
                <button onclick="showReceiveModal()">Receive e-cash</button>
            </div>

            <!-- Key Packages Section -->
            <div id="keypackages-section" class="section">
                <h2>üîë Key Packages</h2>
                <div id="keypackages-status">Loading...</div>
                <div id="keypackages-list"></div>
                <button onclick="createKeyPackage()">Create & Broadcast New KeyPackage</button>
                <button onclick="refreshKeyPackages()">Refresh from Nostr</button>
            </div>

            <!-- Groups Section -->
            <div id="groups-section" class="section">
                <h2>üì± Groups</h2>
                <div id="groups-status">Loading groups...</div>
                <div id="groups-list"></div>
                <button onclick="refreshGroups()">Refresh Groups</button>
                <button onclick="processWelcomes()">Check for Invites</button>
            </div>
        </div>
    </div>

    <!-- Receive Modal -->
    <div id="receive-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; max-width: 600px; margin: 50px auto; padding: 20px; border-radius: 8px;">
            <h2>Receive e-cash Token</h2>
            <p>Paste your Cashu token below:</p>
            <textarea id="token-input" rows="6" style="width: 100%; font-family: monospace; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            <div style="margin-top: 10px;">
                <button onclick="receiveToken()">Receive</button>
                <button onclick="hideReceiveModal()">Cancel</button>
            </div>
            <div id="receive-status" style="margin-top: 10px;"></div>
        </div>
    </div>

    <script type="module">
        import init, {
            get_or_create_keys,
            generate_keys,
            get_npub,
            clear_keys,
            init_wallet,
            get_balance,
            receive_token,
            create_and_broadcast_key_package,
            fetch_my_key_packages,
            get_groups,
            fetch_welcome_events,
            process_pending_welcomes,
            log
        } from './pkg/mdk_ecash_web.js';

        let wasm;

        // Navigation
        window.showSection = function(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            // Show selected section
            document.getElementById(`${sectionName}-section`).classList.add('active');
            event.target.classList.add('active');

            // Load content if needed
            if (sectionName === 'groups') {
                refreshGroups();
            }
        };

        async function loadWasm() {
            try {
                wasm = await init();
                log("WASM module loaded successfully");
                await displayNpub();
                await initializeWallet();
                await initializeKeyPackages();
                await initializeGroups();
                document.getElementById('buttons').style.display = 'block';
                document.getElementById('status').innerHTML = '<div class="success">‚úì Ready</div>';
            } catch (err) {
                console.error('Failed to load WASM:', err);
                document.getElementById('status').innerHTML =
                    `<div class="error">Failed to load WASM: ${err}</div>`;
            }
        }

        async function initializeWallet() {
            try {
                document.getElementById('wallet-status').textContent = 'Initializing wallet...';

                const balance = await init_wallet();
                document.getElementById('balance').textContent = balance;
                document.getElementById('wallet-status').innerHTML = '<div class="success">‚úì Wallet ready</div>';
                log("Wallet initialized with balance: " + balance);
            } catch (err) {
                console.error('Failed to initialize wallet:', err);
                document.getElementById('wallet-status').innerHTML =
                    `<div class="error">Failed to initialize wallet: ${err}</div>`;
            }
        }

        async function initializeKeyPackages() {
            await refreshKeyPackages();
        }

        async function refreshKeyPackages() {
            try {
                document.getElementById('keypackages-status').textContent = 'Loading KeyPackages from Nostr...';

                const packagesJson = await fetch_my_key_packages();
                const packages = JSON.parse(packagesJson);

                // Sort by created_at timestamp, newest first
                packages.sort((a, b) => b.created_at - a.created_at);

                const listDiv = document.getElementById('keypackages-list');
                if (packages.length === 0) {
                    listDiv.innerHTML = '<p style="color: #666;">No KeyPackages found. Create one to get started!</p>';
                    document.getElementById('keypackages-status').innerHTML = '<div class="success">‚úì Ready (0 KeyPackages)</div>';
                } else {
                    listDiv.innerHTML = '<ul style="list-style: none; padding: 0;">' +
                        packages.map(pkg => {
                            const relayStatus = pkg.relays.map(r => {
                                return `<span style="color: green;">‚úì ${r}</span>`;
                            }).join(', ');
                            return `
                            <li style="padding: 10px; background: #f5f5f5; margin: 5px 0; border-radius: 4px;">
                                <strong>Event:</strong> ${pkg.event_id.substring(0, 16)}...<br>
                                <strong>Created:</strong> ${new Date(pkg.created_at * 1000).toLocaleString()}<br>
                                <strong>Content:</strong> ${pkg.content_preview}...<br>
                                <strong>Found on:</strong> ${relayStatus || '<span style="color: red;">No relays</span>'}
                            </li>`;
                        }).join('') +
                        '</ul>';
                    document.getElementById('keypackages-status').innerHTML =
                        `<div class="success">‚úì Found ${packages.length} KeyPackage(s)</div>`;
                }

                log(`Loaded ${packages.length} KeyPackage(s)`);
            } catch (err) {
                console.error('Failed to fetch KeyPackages:', err);
                document.getElementById('keypackages-status').innerHTML =
                    `<div class="error">Failed to load: ${err}</div>`;
            }
        }

        async function initializeGroups() {
            await refreshGroups();
        }

        window.refreshGroups = async function() {
            try {
                document.getElementById('groups-status').textContent = 'Loading groups...';

                const groupsJson = await get_groups();
                const groups = JSON.parse(groupsJson);

                const listDiv = document.getElementById('groups-list');
                if (groups.length === 0) {
                    listDiv.innerHTML = '<p style="color: #666;">No groups yet. Accept an invite to get started!</p>';
                    document.getElementById('groups-status').innerHTML = '<div class="success">‚úì Ready (0 groups)</div>';
                } else {
                    listDiv.innerHTML = groups.map(group => {
                        const lastMessage = group.last_message_at
                            ? new Date(group.last_message_at * 1000).toLocaleString()
                            : 'No messages yet';
                        return `
                        <div class="group-item">
                            <strong>${group.name || 'Unnamed Group'}</strong><br>
                            <small>${group.description || 'No description'}</small><br>
                            <small style="color: #666;">Last activity: ${lastMessage}</small>
                        </div>`;
                    }).join('');
                    document.getElementById('groups-status').innerHTML =
                        `<div class="success">‚úì Found ${groups.length} group(s)</div>`;
                }

                log(`Loaded ${groups.length} group(s)`);
            } catch (err) {
                console.error('Failed to fetch groups:', err);
                document.getElementById('groups-status').innerHTML =
                    `<div class="error">Failed to load: ${err}</div>`;
            }
        };

        window.processWelcomes = async function() {
            const statusDiv = document.getElementById('groups-status');
            statusDiv.innerHTML = 'Checking for new group invites...';

            try {
                // Step 1: Fetch Welcome events from Nostr relays
                statusDiv.innerHTML = 'Fetching invites from Nostr relays...';
                const fetched = await fetch_welcome_events();
                log(`Fetched and processed ${fetched} Welcome event(s)`);

                // Step 2: Auto-accept any pending welcomes
                statusDiv.innerHTML = 'Processing invites...';
                const count = await process_pending_welcomes();

                if (count > 0) {
                    statusDiv.innerHTML = `<div class="success">‚úÖ Joined ${count} new group(s)!</div>`;
                    // Refresh groups list
                    await refreshGroups();
                } else {
                    statusDiv.innerHTML = '<div class="success">No new invites found</div>';
                }
            } catch (err) {
                console.error('Failed to process welcomes:', err);
                statusDiv.innerHTML = `<div class="error">Failed to process invites: ${err}</div>`;
            }
        };

        async function displayNpub() {
            try {
                const npub = get_or_create_keys();
                document.getElementById('npub').textContent = npub;
                document.getElementById('npub-container').style.display = 'block';
            } catch (err) {
                console.error('Failed to get npub:', err);
                document.getElementById('status').innerHTML =
                    `<div class="error">Failed to get keys: ${err}</div>`;
            }
        }

        window.newKeys = async function() {
            try {
                const npub = generate_keys();
                document.getElementById('npub').textContent = npub;
                log("New keys generated: " + npub);
                alert('New keys generated! Previous keys are overwritten.');
            } catch (err) {
                console.error('Failed to generate keys:', err);
                alert('Failed to generate keys: ' + err);
            }
        };

        window.clearKeys = async function() {
            if (confirm('Are you sure you want to clear your keys? This cannot be undone!')) {
                try {
                    clear_keys();
                    document.getElementById('npub-container').style.display = 'none';
                    document.getElementById('status').innerHTML =
                        '<div class="success">Keys cleared. Reload page to generate new keys.</div>';
                } catch (err) {
                    console.error('Failed to clear keys:', err);
                    alert('Failed to clear keys: ' + err);
                }
            }
        };

        window.showReceiveModal = function() {
            document.getElementById('receive-modal').style.display = 'block';
            document.getElementById('token-input').value = '';
            document.getElementById('receive-status').innerHTML = '';
        };

        window.hideReceiveModal = function() {
            document.getElementById('receive-modal').style.display = 'none';
        };

        window.receiveToken = async function() {
            const tokenInput = document.getElementById('token-input').value.trim();
            const statusDiv = document.getElementById('receive-status');

            if (!tokenInput) {
                statusDiv.innerHTML = '<div class="error">Please paste a token</div>';
                return;
            }

            statusDiv.innerHTML = 'Receiving token...';

            try {
                const amount = await receive_token(tokenInput);
                statusDiv.innerHTML = `<div class="success">‚úÖ Received ${amount} sats!</div>`;

                // Update balance display
                const newBalance = await get_balance();
                document.getElementById('balance').textContent = newBalance;

                // Close modal after 2 seconds
                setTimeout(() => {
                    hideReceiveModal();
                }, 2000);
            } catch (err) {
                console.error('Failed to receive token:', err);
                statusDiv.innerHTML = `<div class="error">Failed to receive: ${err}</div>`;
            }
        };

        window.createKeyPackage = async function() {
            const statusDiv = document.getElementById('keypackages-status');
            statusDiv.innerHTML = 'Creating and broadcasting KeyPackage...';

            try {
                const eventId = await create_and_broadcast_key_package();
                log(`KeyPackage created with event ID: ${eventId}`);

                // Refresh the list
                await refreshKeyPackages();
            } catch (err) {
                console.error('Failed to create KeyPackage:', err);
                statusDiv.innerHTML = `<div class="error">Failed to create: ${err}</div>`;
            }
        };

        window.refreshKeyPackages = refreshKeyPackages;

        // Load WASM on page load
        loadWasm();
    </script>
</body>
</html>
